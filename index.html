<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Travel DB</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg-color: #ffffff;
      --text-main: #37352f;
      --text-sub: #787774;
      --border-color: #e2e2e2;
      --hover-bg: #efefef;
      /* ì‚¬ìš©ìê°€ ìš”ì²­í•œ í¬ì¸íŠ¸ ìƒ‰ìƒ ì ìš© */
      --primary: #007fff; 
      --primary-hover: #0066cc; 
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
      margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); 
      line-height: 1.5;
    }
    .container { max-width: 1600px; margin: 0 auto; padding: 40px; }
    .hidden { display: none !important; }
    
    h2 { font-weight: 700; font-size: 28px; letter-spacing: -0.02em; margin-top: 0; color: #111; }
    
    .btn { padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.1s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
    .btn-outline:hover { background: var(--hover-bg); }
    
    /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
    #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
    #login-screen h1 { color: var(--primary); margin-bottom: 8px; font-size: 32px; }
    #login-screen p { color: var(--text-sub); margin-bottom: 30px; }
    .login-btn { display: flex; align-items: center; gap: 10px; padding: 12px 24px; font-size: 16px; border-radius: 8px; border: 1px solid var(--border-color); background: white; cursor: pointer; font-weight: 600; transition: 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .login-btn:hover { background: var(--hover-bg); }

    /* ë…¸ì…˜ ìŠ¤íƒ€ì¼ ì•Œë¡ë‹¬ë¡ íƒœê·¸ */
    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 13px; font-weight: 500; margin-right: 6px; }
    .tag-default { background: #f1f1ef; color: #555; }
    .tag-blue { background: #d3e5ef; color: #0b6e99; }
    .tag-green { background: #ddedea; color: #0f7b6c; }
    .tag-orange { background: #faebdd; color: #d9730d; }
    .tag-yellow { background: #fbf3db; color: #cb912f; }
    .tag-purple { background: #e8deee; color: #6940a5; }
    .tag-pink { background: #f4dfeb; color: #ad1a72; }
    .tag-red { background: #ffe2dd; color: #e03e3e; }
    
    .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-name { font-weight: 600; color: var(--primary); }
    
    #trip-list-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
    }
    
    .trip-card { 
      display: flex; flex-direction: column;
      background: white; border-radius: 8px; padding: 20px; 
      cursor: pointer; border: 1px solid var(--border-color); 
      transition: all 0.2s; position: relative;
    }
    .trip-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); border-color: #ccc; }
    
    .trip-meta-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .trip-title { font-size: 20px; font-weight: 700; margin: 4px 0 12px 0; color: var(--text-main); letter-spacing: -0.01em; }
    .trip-date { font-size: 14px; color: var(--text-sub); }
    
    .trip-cost { font-weight: 700; color: var(--primary); font-size: 24px; margin-top: 20px; }
    
    .icon-btn { cursor: pointer; background: transparent; border: none; padding: 6px; border-radius: 4px; color: #888; transition: 0.1s; display: inline-flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--hover-bg); color: var(--text-main); }
    .card-actions { position: absolute; top: 16px; right: 16px; display: flex; gap: 2px; }

    .tab-menu { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; gap: 10px; }
    .tab { padding: 10px 16px; cursor: pointer; font-weight: 500; color: var(--text-sub); font-size: 15px; border-bottom: 2px solid transparent; }
    .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    
    .day-block { margin-bottom: 40px; }
    .day-header { font-size: 18px; font-weight: 700; margin-bottom: 15px; color: var(--primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; align-items: baseline; }
    .timeline { border-left: 2px solid #e2e2e2; padding-left: 20px; margin-left: 8px; }
    .timeline-item { position: relative; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
    .timeline-item::before { content: ''; position: absolute; left: -25px; top: 4px; width: 8px; height: 8px; border-radius: 50%; background: var(--primary); }
    .timeline-content { flex-grow: 1; }
    .timeline-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: var(--text-main); }
    .timeline-note { font-size: 14px; color: var(--text-sub); line-height: 1.5; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    th { color: var(--text-sub); font-weight: 500; border-bottom: 1px solid #ccc; }
    .text-center { text-align: center; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 32px; border-radius: 8px; width: 90%; max-width: 650px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 20px; }
    
    .form-group { margin-bottom: 16px; }
    .form-row { display: flex; gap: 16px; margin-bottom: 16px; }
    .form-row .form-group { flex: 1; margin-bottom: 0; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: var(--text-sub); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 14px; transition: border 0.1s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
    .modal-actions { text-align: right; margin-top: 24px; }
    
    #loading { text-align: center; padding: 60px; color: var(--text-sub); font-size: 16px; }

    @media screen and (max-width: 768px) {
      .container { padding: 20px 16px; }
      #trip-list-container { grid-template-columns: 1fr; gap: 16px; }
      .header-bar { flex-direction: column; align-items: flex-start; gap: 12px; }
      .header-bar button { width: 100%; }
      .user-info { width: 100%; justify-content: space-between; }
      .detail-header-wrap { flex-direction: column; gap: 12px; padding: 10px 0 20px 0 !important; }
      .detail-header-wrap > div:last-child { width: 100%; justify-content: flex-end; }
      #detail-tags { flex-wrap: wrap; line-height: 2; }
      .tab-menu { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 2px; -webkit-overflow-scrolling: touch; }
      .tab { white-space: nowrap; }
      .expense-header-wrap { flex-direction: column; align-items: flex-start !important; gap: 12px; }
      .expense-header-wrap button { width: 100%; }
      .form-row { flex-direction: column; gap: 0; margin-bottom: 0; }
      .form-row .form-group { margin-bottom: 16px; }
      .modal-content { width: 95%; padding: 24px 16px; }
      .modal-actions { display: flex; flex-direction: column-reverse; gap: 8px; margin-top: 16px; }
      .modal-actions button { width: 100%; margin: 0; }
      .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      table { min-width: 800px; }
      #tab-reviews table { min-width: 600px; }
    }
  </style>
</head>
<body>

<div id="login-screen" class="hidden">
  <h1>ë‚˜ë§Œì˜ ì—¬í–‰ ê¸°ë¡ì¥</h1>
  <p>ì¹œêµ¬ë“¤ê³¼ ë”°ë¡œ, ë‚˜ì˜ ì—¬í–‰ì„ ì•ˆì „í•˜ê²Œ ê¸°ë¡í•˜ì„¸ìš”.</p>
  <button class="login-btn" onclick="loginWithGoogle()">
    <svg width="24" height="24" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
    Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
  </button>
</div>

<div class="container hidden" id="app">
  <div id="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

  <div id="view-list" class="hidden">
    <div class="header-bar">
      <h2>ë‚˜ì˜ ì—¬í–‰ ê¸°ë¡</h2>
      <div class="user-info">
        <span class="user-name" id="display-user-name">ì‚¬ìš©ì</span>
        <button class="btn btn-primary" onclick="openTripModal()">+ ìƒˆ ì—¬í–‰</button>
        <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <div id="trip-list-container"></div>
  </div>

  <div id="view-detail" class="hidden">
    <div class="header-bar" style="margin-bottom: 10px;">
      <button class="btn btn-outline" onclick="goBack()">&larr; ëŒì•„ê°€ê¸°</button>
    </div>
    
    <div class="detail-header-wrap" style="padding: 20px 0 30px 0; display: flex; justify-content: space-between; align-items: flex-start;">
      <div>
        <h2 id="detail-title" style="font-size: 32px; margin-bottom: 12px;">ì—¬í–‰ ì œëª©</h2>
        <div id="detail-tags" style="display: flex; align-items: center; gap: 8px;"></div>
      </div>
      
      <div style="display: flex; gap: 4px;">
        <button class="icon-btn" onclick="openTripModal(currentTripId)" title="ì—¬í–‰ ì •ë³´ ìˆ˜ì •">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </button>
        <button class="icon-btn" onclick="deleteTrip(currentTripId)" title="ì—¬í–‰ í†µì§¸ë¡œ ì‚­ì œ">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        </button>
      </div>
    </div>

    <div class="tab-menu">
      <div class="tab active" onclick="switchTab('itinerary')">ì¼ì •</div>
      <div class="tab" onclick="switchTab('expenses')">ê²½ë¹„</div>
      <div class="tab" onclick="switchTab('reviews')">ê¸°ë¡</div>
    </div>

    <div id="tab-itinerary">
      <div style="text-align:right; margin-bottom:20px;">
        <button class="btn btn-primary" onclick="openItineraryModal()">+ ì¼ì • ì¶”ê°€</button>
      </div>
      <div id="itinerary-container"></div>
    </div>

    <div id="tab-expenses" class="hidden">
      <div class="expense-header-wrap" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div style="font-size: 18px; font-weight: 600;">ì´ ì§€ì¶œ(ë‚˜ì˜ ë¶€ë‹´ì•¡ í•©ì‚°): <span id="detail-total-cost" style="color:var(--primary);">0</span> ì›</div>
        <button class="btn btn-primary" onclick="openExpenseModal()">+ ê²½ë¹„ ì¶”ê°€</button>
      </div>
      <div class="table-wrapper" style="border:1px solid var(--border-color); border-radius:8px; overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>ê²°ì œì¼</th>
              <th>í•­ëª©</th>
              <th>ê²°ì œì</th>
              <th>ìˆ˜ë‹¨</th>
              <th>ê²°ì œì²˜</th>
              <th>ì´ ê²°ì œì•¡</th>
              <th>ì‹¤ì œ ì§€ì¶œì•¡</th>
              <th>ë¹„ê³ </th>
              <th class="text-center">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="expense-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-reviews" class="hidden">
      <div style="text-align:right; margin-bottom:20px;">
        <button class="btn btn-primary" onclick="openReviewModal()">+ ê¸°ë¡ ì¶”ê°€</button>
      </div>
      <div class="table-wrapper" style="border:1px solid var(--border-color); border-radius:8px; overflow-x:auto;">
        <table style="table-layout: fixed;">
          <thead>
            <tr>
              <th style="width: 100px;">ì¼ì°¨</th>
              <th style="width: 120px;">ë¶„ë¥˜</th>
              <th>ê¸°ë¡ ë‚´ìš©</th>
              <th class="text-center" style="width: 120px;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="reviews-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="modal-add-trip" class="modal-overlay hidden">
  <div class="modal-content" style="max-width: 450px;">
    <h3 id="trip-modal-title">ìƒˆ ì—¬í–‰</h3>
    <div class="form-group"><label>ì—¬í–‰ ì œëª©</label><input type="text" id="t-title" placeholder="ì–´ë””ë¡œ ë– ë‚˜ì‹œë‚˜ìš”?"></div>
    <div class="form-row">
      <div class="form-group"><label>ì‹œì‘ì¼</label><input type="date" id="t-start"></div>
      <div class="form-group"><label>ì¢…ë£Œì¼</label><input type="date" id="t-end"></div>
    </div>
    <div class="form-group"><label>ìƒíƒœ</label><select id="t-status"><option value="ì˜ˆì •">ì˜ˆì •</option><option value="ì™„ë£Œ">ì™„ë£Œ</option></select></div>
    <div class="form-group"><label>ë™í–‰ì¸ (ì˜ˆ: ì¹œêµ¬A, ì¹œêµ¬B - ì½¤ë§ˆë¡œ êµ¬ë¶„)</label><input type="text" id="t-companions" placeholder="í•¨ê»˜í•˜ëŠ” ì‚¬ëŒ"></div>
    <div class="form-group"><label>ì´ ì¸ì› (ë³¸ì¸ í¬í•¨)</label><input type="number" id="t-headcount" value="1" min="1"></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-add-trip')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveTrip()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="modal-add-itinerary" class="modal-overlay hidden">
  <div class="modal-content" style="max-width: 400px;">
    <h3 id="itinerary-modal-title">ì¼ì • ì¶”ê°€</h3>
    <div class="form-group" style="display:flex; align-items:center; gap:10px;"><input type="number" id="i-day" style="width:70px;" min="1" value="1"> <span>ì¼ì°¨</span></div>
    <div class="form-group"><label>ì¥ì†Œ ë° ì¼ì •ëª…</label><input type="text" id="i-title" placeholder="ì˜ˆ: ìœ ë‹ˆë²„ì…œ ìŠ¤íŠœë””ì˜¤"></div>
    <div class="form-group"><label>ë©”ëª¨</label><textarea id="i-note" rows="3" placeholder="í•„ìš”í•œ ì •ë³´ë‚˜ ì˜ˆì•½ ë²ˆí˜¸ ë“±"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-add-itinerary')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveItinerary()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="modal-add-expense" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 id="expense-modal-title">ê²½ë¹„ ì¶”ê°€</h3>
    <div class="form-row">
      <div class="form-group"><label>ê²°ì œì¼</label><input type="date" id="e-date"></div>
      <div class="form-group"><label>í•­ëª©</label><input type="text" id="e-category" placeholder="ì˜ˆ: í•­ê³µê¶Œ, ì‹ë¹„"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ê²°ì œì</label><select id="e-payer"></select></div>
      <div class="form-group"><label>ì´ ê²°ì œê¸ˆì•¡</label><input type="text" id="e-amount" placeholder="ìˆ«ìë§Œ ì…ë ¥" oninput="formatNumberInput(this)"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ë‚˜ëˆŒ ì¸ì›ìˆ˜ (ë³¸ì¸í¬í•¨)</label><input type="number" id="e-headcount" min="1" value="1"></div>
      <div class="form-group">
        <label>ìˆ˜ë‹¨</label>
        <select id="e-method" onchange="toggleTransferAmount()">
          <option value="ì¹´ë“œ">ì¹´ë“œ</option><option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option><option value="ì†¡ê¸ˆ">ì†¡ê¸ˆ</option>
        </select>
      </div>
      <div class="form-group"><label>ê²°ì œì²˜</label><input type="text" id="e-merchant" placeholder="ì–´ë””ì„œ ê²°ì œí–ˆë‚˜ìš”?"></div>
    </div>
    <div class="form-group hidden" id="transfer-group"><label>ì‹¤ì œ ì†¡ê¸ˆì•¡ (ë³¸ì¸ì´ ë³„ë„ë¡œ ë³´ë‚¸ ê¸ˆì•¡ì´ ìˆì„ ë•Œë§Œ)</label><input type="text" id="e-transfer-amount" placeholder="ì˜ˆ: 43,500" oninput="formatNumberInput(this)"></div>
    <div class="form-group"><label>ë¹„ê³ </label><input type="text" id="e-note" placeholder="ë©”ëª¨"></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-add-expense')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveExpense()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="modal-add-review" class="modal-overlay hidden">
  <div class="modal-content" style="max-width: 500px;">
    <h3 id="review-modal-title">ê¸°ë¡ ì¶”ê°€</h3>
    <div class="form-row">
      <div class="form-group"><label>ì¼ì°¨</label><select id="r-day"></select></div>
      <div class="form-group">
        <label>ë¶„ë¥˜</label>
        <select id="r-type">
          <option value="">ì„ íƒ ì•ˆí•¨</option><option value="ì—¬í–‰ì§€">ì—¬í–‰ì§€</option><option value="ì‹ì‚¬">ì‹ì‚¬</option><option value="ìˆ™ì†Œ">ìˆ™ì†Œ</option><option value="ì´í‰">ì´í‰</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label>ê¸°ë¡ ë‚´ìš©</label><textarea id="r-text" rows="5" placeholder="ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-add-review')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveReview()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  // ==========================================
  // ğŸš€ Firebase ì—°ë™ ì„¸íŒ… (ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”!)
  // ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyAV5DMWNV12mLs2zgWP4WjekoiPpdwMHd0",
    authDomain: "travel-record-d83ac.firebaseapp.com",
    projectId: "travel-record-d83ac",
    storageBucket: "travel-record-d83ac.firebasestorage.app",
    messagingSenderId: "865013925949",
    appId: "1:865013925949:web:04c73a9ded2b9b9d530254"
  };
  
  // íŒŒì´ì–´ë² ì´ìŠ¤ ì´ˆê¸°í™”
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const dbStore = firebase.firestore();

  let currentUser = null;
  let DB = { trips: [] };
  let currentTripId = null;
  
  let editingTripId = null, editingItineraryId = null, editingExpenseId = null, editingReviewId = null;

  // ==========================================
  // ë¡œê·¸ì¸ ë° ìœ ì € ìƒíƒœ ê´€ë¦¬
  // ==========================================
  window.onload = function() {
    // ì•±ì´ ì¼œì§€ë©´ ìœ ì € ë¡œê·¸ì¸ ìƒíƒœë¥¼ ê°ì‹œí•©ë‹ˆë‹¤.
    auth.onAuthStateChanged(user => {
      if (user) {
        // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ
        currentUser = user;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('display-user-name').innerText = user.displayName + "ë‹˜ì˜ ì—¬í–‰";
        loadTravelData(); // íŒŒì´ì–´ë² ì´ìŠ¤ì—ì„œ ë‚´ ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ê¸°
      } else {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ì‹œ
        currentUser = null;
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
      }
    });
  };

  function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert("ë¡œê·¸ì¸ ì—ëŸ¬: " + err.message));
  }

  function logout() {
    if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) auth.signOut();
  }

  // ==========================================
  // íŒŒì´ì–´ë² ì´ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  // ==========================================
  async function loadTravelData() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('view-list').classList.add('hidden');
    DB = { trips: [] };

    try {
      const uid = currentUser.uid;
      
      // ë‚´ ë°ì´í„°ë§Œ ì™ì™ ê³¨ë¼ì„œ ê°€ì ¸ì˜¤ê¸°
      const [tripsSnap, itiSnap, expSnap, revSnap] = await Promise.all([
        dbStore.collection('trips').where('userId', '==', uid).get(),
        dbStore.collection('itineraries').where('userId', '==', uid).get(),
        dbStore.collection('expenses').where('userId', '==', uid).get(),
        dbStore.collection('reviews').where('userId', '==', uid).get()
      ]);

      const itiData = itiSnap.docs.map(d => d.data());
      const expData = expSnap.docs.map(d => d.data());
      const revData = revSnap.docs.map(d => d.data());

      tripsSnap.forEach(doc => {
        const t = doc.data();
        DB.trips.push({
          id: t.id,
          title: t.title || 'ì œëª© ì—†ìŒ',
          start: t.start || '',
          end: t.end || '',
          status: t.status || 'ì˜ˆì •',
          companions: t.companions || '',
          headcount: Number(t.headcount) || 1,
          orderIndex: Number(t.orderIndex) || 0,
          itinerary: itiData.filter(i => String(i.tripId) === String(t.id)),
          expenses: expData.filter(e => String(e.tripId) === String(t.id)),
          reviews: revData.filter(r => String(r.tripId) === String(t.id))
        });
      });

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('view-list').classList.remove('hidden');
      renderTripList();

    } catch (err) {
      document.getElementById('loading').innerHTML = '<div style="color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message + '</div>';
    }
  }

  // UI ì œì–´ìš© í•¨ìˆ˜ë“¤
  function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  
  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-itinerary').classList.add('hidden');
    document.getElementById('tab-expenses').classList.add('hidden');
    document.getElementById('tab-reviews').classList.add('hidden');
    event.target.classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
  }

  function goBack() {
    document.getElementById('view-detail').classList.add('hidden');
    document.getElementById('view-list').classList.remove('hidden');
    currentTripId = null;
    renderTripList();
  }

  function fmt(num) { return num ? Number(num).toLocaleString('ko-KR') : '0'; }
  function formatNumberInput(el) {
    let val = el.value.replace(/,/g, '').replace(/[^0-9]/g, '');
    if (val) el.value = Number(val).toLocaleString('ko-KR');
    else el.value = '';
  }

  function getNotionColorClass(text) {
    if (!text) return 'tag-default';
    switch(text.trim()) {
      case 'ì˜ˆì •': return 'tag-blue';
      case 'ì™„ë£Œ': return 'tag-green';
      case 'ì¹´ë“œ': return 'tag-orange';
      case 'í˜„ê¸ˆ': return 'tag-green';
      case 'ì†¡ê¸ˆ': return 'tag-pink';
      case 'ì—¬í–‰ì§€': return 'tag-blue';
      case 'ì‹ì‚¬': return 'tag-yellow';
      case 'ìˆ™ì†Œ': return 'tag-purple';
      case 'ì´í‰': return 'tag-red';
      default: return 'tag-default';
    }
  }

  function getCalculatedDateStr(startDateStr, dayNumber) {
    if (!startDateStr) return '';
    const date = new Date(startDateStr);
    if (isNaN(date.getTime())) return '';
    date.setDate(date.getDate() + (dayNumber - 1));
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `(${y}ë…„ ${m}ì›” ${d}ì¼)`;
  }

  // ==========================================
  // ì—¬í–‰ ê´€ë¦¬ (Firestore í†µì‹  í¬í•¨)
  // ==========================================
  function openTripModal(tripId = null) {
    if (tripId && typeof tripId === 'string') {
      editingTripId = tripId;
      document.getElementById('trip-modal-title').innerText = 'ì—¬í–‰ ìˆ˜ì •';
      const trip = DB.trips.find(t => String(t.id) === String(tripId));
      document.getElementById('t-title').value = trip.title;
      document.getElementById('t-start').value = trip.start;
      document.getElementById('t-end').value = trip.end;
      document.getElementById('t-status').value = trip.status;
      document.getElementById('t-companions').value = trip.companions;
      document.getElementById('t-headcount').value = trip.headcount;
    } else {
      editingTripId = null;
      document.getElementById('trip-modal-title').innerText = 'ìƒˆ ì—¬í–‰';
      document.getElementById('t-title').value = '';
      document.getElementById('t-start').value = '';
      document.getElementById('t-end').value = '';
      document.getElementById('t-status').value = 'ì˜ˆì •';
      document.getElementById('t-companions').value = '';
      document.getElementById('t-headcount').value = 1;
    }
    openModal('modal-add-trip');
  }

  function saveTrip() {
    const tripData = {
      userId: currentUser.uid, // ëˆ„êµ¬ì˜ ì—¬í–‰ì¸ì§€ ê¼¬ë¦¬í‘œ ë¶™ì´ê¸°
      title: document.getElementById('t-title').value || 'ì œëª© ì—†ìŒ',
      start: document.getElementById('t-start').value,
      end: document.getElementById('t-end').value,
      status: document.getElementById('t-status').value,
      companions: document.getElementById('t-companions').value,
      headcount: parseInt(document.getElementById('t-headcount').value) || 1
    };

    if (editingTripId) {
      tripData.id = editingTripId;
      const trip = DB.trips.find(t => String(t.id) === String(editingTripId));
      Object.assign(trip, tripData);
      
      // íŒŒì´ì–´ë² ì´ìŠ¤ ìˆ˜ì •
      dbStore.collection('trips').doc(String(editingTripId)).update(tripData);
      if (currentTripId === editingTripId) openTripDetail(currentTripId); 
    } else {
      tripData.id = Date.now().toString();
      tripData.orderIndex = DB.trips.length;
      tripData.itinerary = [];
      tripData.expenses = [];
      tripData.reviews = [];
      DB.trips.push(tripData);
      
      // íŒŒì´ì–´ë² ì´ìŠ¤ ì¶”ê°€
      dbStore.collection('trips').doc(String(tripData.id)).set(tripData);
    }
    
    renderTripList();
    closeModal('modal-add-trip');
  }

  async function deleteTrip(tripId) {
    if (!confirm("ì´ ì—¬í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ëœ ì¼ì •ê³¼ ê²½ë¹„ê°€ ëª¨ë‘ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
    
    // ë¡œì»¬ ì‚­ì œ
    DB.trips = DB.trips.filter(t => String(t.id) !== String(tripId));
    if (currentTripId === tripId) goBack();
    else renderTripList();
    
    // íŒŒì´ì–´ë² ì´ìŠ¤ ì‚­ì œ (ë³¸ì¸ ê²ƒë§Œ í™•ì‹¤í•˜ê²Œ ì‚­ì œ)
    await dbStore.collection('trips').doc(String(tripId)).delete();
    // (ì°¸ê³ : ì§„ì§œ ì™„ë²½í•˜ê²Œ í•˜ë ¤ë©´ ì—¬í–‰ì— ë”¸ë¦° ë¹„ìš©, ë¦¬ë·° ë“±ë„ ì°¾ì•„ì„œ ì‚­ì œí•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•˜ì§€ë§Œ, 
    // ê°œì¸ìš© ìŠ¤ì¼€ì¼ì—ì„œëŠ” ìƒìœ„ ì—¬í–‰ ì‚­ì œë§Œìœ¼ë¡œë„ í™”ë©´ì—ì„œ ì‚¬ë¼ì§€ë¯€ë¡œ ê°€ë³ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.)
  }

  function renderTripList() {
    const container = document.getElementById('trip-list-container');
    container.innerHTML = '';
    
    if (!DB.trips || DB.trips.length === 0) {
      container.style.display = 'block';
      container.innerHTML = '<div style="text-align: center; color: var(--text-sub); padding: 50px 0;">ì²« ë²ˆì§¸ ì—¬í–‰ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>';
      return;
    }
    
    container.style.display = 'grid'; 
    const sortedTrips = [...DB.trips].sort((a, b) => a.orderIndex - b.orderIndex);
    
    sortedTrips.forEach(trip => {
      let totalPerPerson = trip.expenses.reduce((sum, exp) => {
        if (exp.method === 'ì†¡ê¸ˆ' && exp.transferAmount > 0) return sum + exp.transferAmount;
        let cnt = exp.headcount > 0 ? exp.headcount : 1;
        return sum + (exp.amount / cnt);
      }, 0);

      const statusColorClass = getNotionColorClass(trip.status);
      const companionsTag = trip.companions ? `<span class="tag tag-default">${trip.companions}</span>` : '';
      
      container.innerHTML += `
        <div class="trip-card" onclick="openTripDetail('${trip.id}')">
          <div class="card-actions">
            <button class="icon-btn" onclick="event.stopPropagation(); openTripModal('${trip.id}')" title="ìˆ˜ì •"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
            <button class="icon-btn" onclick="event.stopPropagation(); deleteTrip('${trip.id}')" title="ì‚­ì œ"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
          </div>
          <div class="trip-meta-header">
             <span class="tag ${statusColorClass}">${trip.status}</span><span class="trip-date">${trip.start} ~ ${trip.end}</span>
          </div>
          <div class="trip-title">${trip.title}</div>
          <div>${companionsTag} <span style="font-size:13px; color:var(--text-sub);">(${trip.headcount}ëª…)</span></div>
          <div class="trip-cost">${fmt(Math.round(totalPerPerson))} ì›</div>
          <div style="position: absolute; bottom: 16px; right: 16px; display:flex; gap: 4px;">
            <button class="icon-btn" onclick="event.stopPropagation(); moveTripOrder('${trip.id}', -1)" title="ìˆœì„œ ìœ„ë¡œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
            <button class="icon-btn" onclick="event.stopPropagation(); moveTripOrder('${trip.id}', 1)" title="ìˆœì„œ ì•„ë˜ë¡œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
          </div>
        </div>`;
    });
  }

  function moveTripOrder(tripId, direction) {
    const currentIndex = DB.trips.findIndex(t => String(t.id) === String(tripId));
    const targetIndex = currentIndex + direction;
    if(targetIndex >= 0 && targetIndex < DB.trips.length) {
      const tempOrder = DB.trips[currentIndex].orderIndex;
      DB.trips[currentIndex].orderIndex = DB.trips[targetIndex].orderIndex;
      DB.trips[targetIndex].orderIndex = tempOrder;
      DB.trips.sort((a, b) => a.orderIndex - b.orderIndex);
      renderTripList();
      
      // Firestore ì¼ê´„ ì—…ë°ì´íŠ¸
      const batch = dbStore.batch();
      const ref1 = dbStore.collection('trips').doc(String(DB.trips[currentIndex].id));
      const ref2 = dbStore.collection('trips').doc(String(DB.trips[targetIndex].id));
      batch.update(ref1, { orderIndex: DB.trips[currentIndex].orderIndex });
      batch.update(ref2, { orderIndex: DB.trips[targetIndex].orderIndex });
      batch.commit();
    }
  }

  function openTripDetail(id) {
    currentTripId = id;
    const trip = DB.trips.find(t => String(t.id) === String(id));
    
    document.getElementById('view-list').classList.add('hidden');
    document.getElementById('view-detail').classList.remove('hidden');
    
    document.getElementById('detail-title').innerText = trip.title;
    const statusColorClass = getNotionColorClass(trip.status);
    const compTag = trip.companions ? `<span class="tag tag-default">${trip.companions}</span>` : '';
    document.getElementById('detail-tags').innerHTML = `
      <span class="tag ${statusColorClass}">${trip.status}</span>
      <span class="trip-date" style="margin-right:8px;">${trip.start} ~ ${trip.end}</span>
      ${compTag} <span style="font-size:14px; color:var(--text-sub);">(${trip.headcount}ëª…)</span>
    `;
    
    renderItinerary();
    renderExpenses();
    renderReviews();
  }

  // ==========================================
  // ì¼ì • ê´€ë¦¬
  // ==========================================
  function openItineraryModal(itemId = null) {
    if (itemId && typeof itemId === 'string') {
      editingItineraryId = itemId;
      document.getElementById('itinerary-modal-title').innerText = 'ì¼ì • ìˆ˜ì •';
      const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
      const item = trip.itinerary.find(i => String(i.id) === String(itemId));
      document.getElementById('i-day').value = item.day;
      document.getElementById('i-title').value = item.title;
      document.getElementById('i-note').value = item.note;
    } else {
      editingItineraryId = null;
      document.getElementById('itinerary-modal-title').innerText = 'ì¼ì • ì¶”ê°€';
      document.getElementById('i-day').value = 1;
      document.getElementById('i-title').value = '';
      document.getElementById('i-note').value = '';
    }
    openModal('modal-add-itinerary');
  }

  function saveItinerary() {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const day = parseInt(document.getElementById('i-day').value);
    
    if (editingItineraryId) {
      const item = trip.itinerary.find(i => String(i.id) === String(editingItineraryId));
      item.day = day;
      item.title = document.getElementById('i-title').value;
      item.note = document.getElementById('i-note').value;
      dbStore.collection('itineraries').doc(String(editingItineraryId)).update(item);
    } else {
      const newItem = {
        id: Date.now().toString(),
        userId: currentUser.uid,
        tripId: currentTripId,
        day: day,
        title: document.getElementById('i-title').value,
        note: document.getElementById('i-note').value,
        orderIndex: trip.itinerary.filter(i => i.day === day).length
      };
      trip.itinerary.push(newItem);
      dbStore.collection('itineraries').doc(String(newItem.id)).set(newItem);
    }
    renderItinerary();
    closeModal('modal-add-itinerary');
  }

  function deleteItinerary(itemId) {
    if(!confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    trip.itinerary = trip.itinerary.filter(i => String(i.id) !== String(itemId));
    renderItinerary();
    dbStore.collection('itineraries').doc(String(itemId)).delete();
  }

  function renderItinerary() {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const container = document.getElementById('itinerary-container');
    container.innerHTML = '';
    
    const days = [...new Set(trip.itinerary.map(i => i.day))].sort((a,b)=>a-b);
    days.forEach(day => {
      const dayItems = trip.itinerary.filter(i => i.day === day).sort((a,b)=>a.orderIndex-b.orderIndex);
      let dateHtml = trip.start ? `<span style="font-size:14px; color:var(--text-sub); font-weight:500; margin-left:8px;">${getCalculatedDateStr(trip.start, day)}</span>` : '';

      let html = `<div class="day-block"><div class="day-header">Day ${day} ${dateHtml}</div><div class="timeline">`;
      dayItems.forEach((item) => {
        html += `<div class="timeline-item"><div class="timeline-content"><div class="timeline-title">${item.title}</div><div class="timeline-note">${item.note.replace(/\n/g, '<br>')}</div></div>
          <div style="display:flex; flex-direction:row; align-items:center; gap: 4px;">
            <button class="icon-btn" style="padding: 2px;" onclick="openItineraryModal('${item.id}')" title="ìˆ˜ì •"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
            <button class="icon-btn" style="padding: 2px;" onclick="deleteItinerary('${item.id}')" title="ì‚­ì œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
            <div style="width: 1px; height: 16px; background: var(--border-color); margin: 0 4px;"></div>
            <button class="icon-btn" style="padding: 2px;" onclick="moveItinerary('${item.id}', -1)" title="ìœ„ë¡œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
            <button class="icon-btn" style="padding: 2px;" onclick="moveItinerary('${item.id}', 1)" title="ì•„ë˜ë¡œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
          </div></div>`;
      });
      html += `</div></div>`;
      container.innerHTML += html;
    });
  }

  function moveItinerary(itemId, direction) {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const item = trip.itinerary.find(i => String(i.id) === String(itemId));
    const dayItems = trip.itinerary.filter(i => i.day === item.day).sort((a,b)=>a.orderIndex-b.orderIndex);
    
    const currentIndex = dayItems.findIndex(i => String(i.id) === String(itemId));
    const targetIndex = currentIndex + direction;
    
    if(targetIndex >= 0 && targetIndex < dayItems.length) {
      const tempOrder = dayItems[currentIndex].orderIndex;
      dayItems[currentIndex].orderIndex = dayItems[targetIndex].orderIndex;
      dayItems[targetIndex].orderIndex = tempOrder;
      renderItinerary(); 
      
      const batch = dbStore.batch();
      batch.update(dbStore.collection('itineraries').doc(String(dayItems[currentIndex].id)), { orderIndex: dayItems[currentIndex].orderIndex });
      batch.update(dbStore.collection('itineraries').doc(String(dayItems[targetIndex].id)), { orderIndex: dayItems[targetIndex].orderIndex });
      batch.commit();
    }
  }

  // ==========================================
  // ê²½ë¹„ ê´€ë¦¬
  // ==========================================
  function openExpenseModal(expId = null) {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const payerSelect = document.getElementById('e-payer');
    
    payerSelect.innerHTML = `<option value="ë‚˜">ë‚˜</option>`;
    if (trip.companions && trip.companions !== 'undefined') {
      const companionsList = String(trip.companions).split(',').map(s => s.trim());
      companionsList.forEach(c => { if(c) payerSelect.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    if (expId && typeof expId === 'string') {
      editingExpenseId = expId;
      document.getElementById('expense-modal-title').innerText = 'ê²½ë¹„ ìˆ˜ì •';
      const exp = trip.expenses.find(e => String(e.id) === String(expId));
      
      document.getElementById('e-date').value = exp.date || '';
      document.getElementById('e-category').value = exp.category || '';
      if (![...payerSelect.options].map(o => o.value).includes(exp.payer)) {
         if(exp.payer) payerSelect.innerHTML += `<option value="${exp.payer}">${exp.payer}</option>`;
      }
      document.getElementById('e-payer').value = exp.payer || 'ë‚˜';
      document.getElementById('e-amount').value = exp.amount ? fmt(exp.amount) : '';
      document.getElementById('e-headcount').value = exp.headcount || trip.headcount;
      document.getElementById('e-method').value = exp.method || 'ì¹´ë“œ';
      document.getElementById('e-merchant').value = exp.merchant || '';
      document.getElementById('e-transfer-amount').value = exp.transferAmount ? fmt(exp.transferAmount) : '';
      document.getElementById('e-note').value = exp.note || '';
    } else {
      editingExpenseId = null;
      document.getElementById('expense-modal-title').innerText = 'ê²½ë¹„ ì¶”ê°€';
      document.getElementById('e-date').value = '';
      document.getElementById('e-category').value = '';
      document.getElementById('e-payer').value = 'ë‚˜';
      document.getElementById('e-amount').value = '';
      document.getElementById('e-headcount').value = trip.headcount;
      document.getElementById('e-method').value = 'ì¹´ë“œ';
      document.getElementById('e-merchant').value = '';
      document.getElementById('e-transfer-amount').value = '';
      document.getElementById('e-note').value = '';
    }
    toggleTransferAmount();
    openModal('modal-add-expense');
  }

  function toggleTransferAmount() {
    const method = document.getElementById('e-method').value;
    const transferGroup = document.getElementById('transfer-group');
    if (method === 'ì†¡ê¸ˆ') transferGroup.classList.remove('hidden');
    else { transferGroup.classList.add('hidden'); document.getElementById('e-transfer-amount').value = ''; }
  }

  function saveExpense() {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const rawAmount = document.getElementById('e-amount').value.replace(/,/g, '');
    const rawTransfer = document.getElementById('e-transfer-amount').value.replace(/,/g, '');

    const expenseData = {
      userId: currentUser.uid,
      tripId: currentTripId,
      date: document.getElementById('e-date').value,
      category: document.getElementById('e-category').value,
      payer: document.getElementById('e-payer').value,
      method: document.getElementById('e-method').value,
      amount: parseInt(rawAmount) || 0,
      headcount: parseInt(document.getElementById('e-headcount').value) || 1,
      merchant: document.getElementById('e-merchant').value,
      transferAmount: parseInt(rawTransfer) || 0,
      note: document.getElementById('e-note').value
    };

    if (editingExpenseId) {
      expenseData.id = editingExpenseId;
      const index = trip.expenses.findIndex(e => String(e.id) === String(editingExpenseId));
      if(index > -1) trip.expenses[index] = expenseData;
      dbStore.collection('expenses').doc(String(editingExpenseId)).update(expenseData);
    } else {
      expenseData.id = Date.now().toString();
      trip.expenses.push(expenseData);
      dbStore.collection('expenses').doc(String(expenseData.id)).set(expenseData);
    }
    renderExpenses();
    closeModal('modal-add-expense');
  }

  function deleteExpense(expenseId) {
    if(!confirm("ì´ ê²½ë¹„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    trip.expenses = trip.expenses.filter(e => String(e.id) !== String(expenseId));
    renderExpenses();
    dbStore.collection('expenses').doc(String(expenseId)).delete();
  }

  function renderExpenses() {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const tbody = document.getElementById('expense-tbody');
    tbody.innerHTML = '';
    
    let totalPerPersonSum = 0; 
    const sortedExpenses = [...trip.expenses].sort((a,b) => (a.date > b.date) ? 1 : -1);

    sortedExpenses.forEach(exp => {
      let totalAmountHtml = `${fmt(exp.amount)}ì›`;
      let actualExpense = exp.amount;
      let actualExpenseHtml = '';

      if (exp.headcount > 1) actualExpense = Math.round(exp.amount / exp.headcount);
      
      if (exp.method === 'ì†¡ê¸ˆ' && exp.transferAmount > 0) {
        actualExpense = exp.transferAmount;
        actualExpenseHtml = `<span style="color:var(--text-main); font-weight:600;">${fmt(actualExpense)}ì›</span> <span style="font-size:12px; color:var(--text-sub);">(ì†¡ê¸ˆ)</span>`;
      } else {
        actualExpenseHtml = `<span style="font-weight:600; color:var(--text-main);">${fmt(actualExpense)}ì›</span>`;
        if (exp.headcount > 1) actualExpenseHtml += ` <span style="font-size:12px; color:var(--text-sub);">(1/${exp.headcount})</span>`;
      }

      totalPerPersonSum += actualExpense;
      const methodColorClass = getNotionColorClass(exp.method);
      
      tbody.innerHTML += `<tr>
          <td style="color:var(--text-sub); font-size:13px;">${exp.date || '-'}</td>
          <td style="font-weight: 500;">${exp.category || '-'}</td>
          <td>${exp.payer || 'ë‚˜'}</td>
          <td><span class="tag ${methodColorClass}">${exp.method}</span></td>
          <td>${exp.merchant || '-'}</td>
          <td style="color:var(--text-sub);">${totalAmountHtml}</td>
          <td>${actualExpenseHtml}</td>
          <td style="font-size: 13px;">${exp.note || '-'}</td>
          <td class="text-center" style="white-space: nowrap;">
            <button class="icon-btn" onclick="openExpenseModal('${exp.id}')" title="ìˆ˜ì •"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
            <button class="icon-btn" onclick="deleteExpense('${exp.id}')" title="ì‚­ì œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
          </td>
        </tr>`;
    });
    document.getElementById('detail-total-cost').innerText = fmt(totalPerPersonSum);
  }

  // ==========================================
  // ê¸°ë¡(ë¦¬ë·°) ê´€ë¦¬
  // ==========================================
  function openReviewModal(reviewId = null) {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const daySelect = document.getElementById('r-day');
    
    const maxDay = trip.itinerary.length > 0 ? Math.max(...trip.itinerary.map(i => i.day)) : 1;
    daySelect.innerHTML = '<option value="">ì„ íƒ ì•ˆí•¨</option>';
    for(let i=1; i<=maxDay; i++) { daySelect.innerHTML += `<option value="Day ${i}">Day ${i}</option>`; }

    if (reviewId && typeof reviewId === 'string') {
      editingReviewId = reviewId;
      document.getElementById('review-modal-title').innerText = 'ê¸°ë¡ ìˆ˜ì •';
      const rev = trip.reviews.find(r => String(r.id) === String(reviewId));
      document.getElementById('r-day').value = rev.day || '';
      document.getElementById('r-type').value = rev.type || '';
      document.getElementById('r-text').value = rev.text || '';
    } else {
      editingReviewId = null;
      document.getElementById('review-modal-title').innerText = 'ê¸°ë¡ ì¶”ê°€';
      document.getElementById('r-day').value = '';
      document.getElementById('r-type').value = '';
      document.getElementById('r-text').value = '';
    }
    openModal('modal-add-review');
  }

  function saveReview() {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const reviewData = {
      userId: currentUser.uid,
      tripId: currentTripId,
      day: document.getElementById('r-day').value,
      type: document.getElementById('r-type').value,
      text: document.getElementById('r-text').value
    };

    if (editingReviewId) {
      reviewData.id = editingReviewId;
      const index = trip.reviews.findIndex(r => String(r.id) === String(editingReviewId));
      if(index > -1) trip.reviews[index] = reviewData;
      dbStore.collection('reviews').doc(String(editingReviewId)).update(reviewData);
    } else {
      reviewData.id = Date.now().toString();
      trip.reviews.push(reviewData);
      dbStore.collection('reviews').doc(String(reviewData.id)).set(reviewData);
    }
    renderReviews();
    closeModal('modal-add-review');
  }

  function deleteReview(reviewId) {
    if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    trip.reviews = trip.reviews.filter(r => String(r.id) !== String(reviewId));
    renderReviews();
    dbStore.collection('reviews').doc(String(reviewId)).delete();
  }

  function renderReviews() {
    const trip = DB.trips.find(t => String(t.id) === String(currentTripId));
    const tbody = document.getElementById('reviews-tbody');
    tbody.innerHTML = '';
    
    trip.reviews.forEach(rev => {
      const typeColorClass = getNotionColorClass(rev.type);
      tbody.innerHTML += `<tr>
          <td style="font-weight: 500;">${rev.day || '-'}</td>
          <td><span class="tag ${typeColorClass}">${rev.type || 'ë¯¸ë¶„ë¥˜'}</span></td>
          <td style="white-space: pre-wrap; line-height: 1.6;">${rev.text}</td>
          <td class="text-center">
            <button class="icon-btn" onclick="openReviewModal('${rev.id}')" title="ìˆ˜ì •"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
            <button class="icon-btn" onclick="deleteReview('${rev.id}')" title="ì‚­ì œ"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
          </td>
        </tr>`;
    });
  }
</script>
</body>
</html>